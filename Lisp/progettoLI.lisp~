;;;; -*- Mode: Lisp -*-

;;;; Masiero Emanuele 872695 
;;;; Banfi Michele 869294

;;;; uri-parse.lisp --

;;structure: scheme - fragment - query - path - user - port - host

(defun uri-parse (uri)
  (boia-de (return_scheme (coerce uri 'list) NIL))
  )

(defun dialler (x)
  (cond ((equal (first x) "mailto")(mailto x)) 
	((equal (first x) "news")(news x))
        ((equal (first x) "tel")(telfax x))
        ((equal (first x) "fax")(telfax x))
        (T (scheme-grammar (coerce (first x) 'list) x) )
        )
  )

(defun boia-de (x) 
  (cond ((equal (fifth x) "") (error "illegal userinfo")) ;userinfo
        ((equal (second x) "") (error "illegal fragment")) ;fragment
        ((equal (third x) "") (error "illegal query")) ;query
        ((equal (fourth x) "") (error "illegal path")) ;path
        ((equal (sixth x) "") (error "illegal port")) ;port
        ((equal (last (coerce (fourth x) 'list))'(#\/))
         (error "illegal end of path with '/'")) ;path that end with /
        (T (dialler x))
        )
  )

;;scheme - NIL - NIL - NIL - user - NIL - host
(defun mailto (scheme)
  (dialler-mailto (resetter-mailto scheme))
  )

(defun dialler-mailto (scheme)
  (query-grammar (coerce (third scheme) 'list) scheme)
  )

(defun resetter-mailto (scheme)
  (cons (first scheme)
	(cons "NIL"
	      (cons "NIL"
		    (cons "NIL"
			  (cons (fifth scheme)
				(cons "NIL" (cons (seventh scheme) NIL)))))))
  )

;;scheme - NIL - NIL - NIL - NIL - NIL - host
(defun news (scheme)
  (dialler-news (resetter-news scheme))
  )

(defun dialler-news (scheme)
  (query-grammar (coerce (third scheme) 'list) scheme)
  )

(defun resetter-news (scheme)
  (cons (first scheme)
	(cons "NIL"
	      (cons "NIL"
		    (cons "NIL"
			  (cons "NIL"
				(cons "NIL"
				      (cons (seventh scheme) NIL)))))))
  )

;;scheme - NIL - NIL - NIL - host - NIL - NIL
(defun telfax (scheme)
  (dialler-telfax (resetter-telfax scheme))
  )

(defun dialler-telfax (scheme)
  (query-grammar (coerce (third scheme) 'list) scheme)
  )

(defun resetter-telfax (scheme)
  (cons (first scheme)
	(cons "NIL"
	      (cons "NIL"
		    (cons "NIL"
			  (cons (seventh scheme)
				(cons "NIL" (cons "NIL" NIL)))))))
  )

(defun scheme-grammar (scheme uri)
  (cond ((null scheme) (query-grammar (coerce (third  uri) 'list) uri))
        ( (equal (car scheme) #\/)  (error "illegal uri-scheme char found /"))
        ( (equal (car scheme) #\?)  (error "illegal uri-scheme char found ?"))
        ( (equal (car scheme) #\#)  (error "illegal uri-scheme char found #"))
        ( (equal (car scheme) #\@)  (error "illegal uri-scheme char found @"))
        ( (equal (car scheme) #\:)  (error "illegal uri-scheme char found :"))
        (T (scheme-grammar (cdr scheme) uri))
        )
  )

(defun query-grammar (query uri)
  (cond ((and (equal (first uri) "zos") (null query)) 
         (zos-path-grammar (coerce (fourth uri) 'list) '()  uri))
        ((null query) (path-grammar (coerce (fourth uri) 'list)  uri))
        ( (equal (car query) #\#) (error "illegal uri-query char"))
        (T (query-grammar (cdr query) uri)))
  )

(defun zos-path-grammar (path y uri)
  (cond ((null path) 
         (cond ((> (length y) 44)  
                (error "illegal zos id44 length"))
               ((equal (car y) #\.) 
                (error "illegal end of id44. terminated with '.'"))
               ((not (alpha-char-p 
                      (car (last y)))) 
                (error "illegal start of id44 with non alphabetic char"))
               (T (userinfo-grammar (coerce (fifth uri) 'list) uri))
               ))
        ( (equal (car path) #\( ) 
          (cond ((> (length y) 44)  (error "illegal zos id44 length"))
                ((equal (car y) #\.) 
                 (error "illegal end of id44. terminated with '.'"))
                ((not (alpha-char-p (car (last y)))) 
                 (error "illegal start of id44 with non alphabetic char"))
                (T (zos-inside-brackets (cdr path) '() y uri))
                ))
        (T (zos-path-grammar (cdr path) (cons (car path) y) uri))
        )
  )

(defun zos-inside-brackets (path y id44 uri)
  (cond ((null path)(error "illegal zos-scheme missing ')'"))
        ( (equal (car path) #\) ) 
          (cond ( (> (length y) 8) 
                  (error "illegal zos id8 length"))
                ((not (alpha-char-p (car (last y)))) 
                 (error "illegal start of id8 with non alphabetic char"))
                ((not (equal (car (last path)) #\) )) 
                 (error "illegal end of id44 path"))
                (T (userinfo-grammar (coerce (fifth uri) 'list) uri))
                ))
        (T (zos-inside-brackets (cdr path) (cons (car path) y) id44 uri))
        )
  )

(defun path-grammar (path uri)
  (cond ((null path) (userinfo-grammar (coerce (fifth uri) 'list)  uri))
        ( (equal (car path) #\?)  (error "illegal uri-path char found ?"))
        ( (equal (car path) #\#)  (error "illegal uri-path char found #"))
        ( (equal (car path) #\@)  (error "illegal uri-path char found @"))
        ( (equal (car path) #\:)  (error "illegal uri-path char found :"))
        ( (and (equal (car path) #\/) (equal (car path) (car (cdr path)) )) 
          (error "illegal uri-path char sequence //"))
        (T (path-grammar (cdr path) uri))
        )
  )

(defun userinfo-grammar (userinfo uri)
  (cond ((equal userinfo "") (error "boia"))
        ( (null userinfo) (host-grammar (coerce (seventh  uri) 'list) uri))
        ( (equal (car userinfo) #\/)  
          (error "illegal uri-userinfo char found /"))
        ( (equal (car userinfo) #\?)  
          (error "illegal uri-userinfo char found ?"))
        ( (equal (car userinfo) #\#)  
          (error "illegal uri-userinfo char found #"))
        ( (equal (car userinfo) #\@)  
          (error "illegal uri-userinfo char found @"))
        ( (equal (car userinfo) #\:)  
          (error "illegal uri-userinfo char found :"))
        (T (userinfo-grammar (cdr userinfo) uri))
        )
  )

(defun host-grammar (host uri)
  (cond ((null host) (port-grammar (sixth uri)  uri))
        ( (equal (car host) #\?)  (error "illegal uri-host char found ?"))
        ( (equal (car host) #\#)  (error "illegal uri-host char found #"))
        ( (equal (car host) #\@)  (error "illegal uri-host char found @"))
        ( (equal (car host) #\:)  (error "illegal uri-host char found :"))
        ( (equal (last host) '(#\.))  (error "illegal end of scheme"))
        ( (and (equal (car host) #\.) (equal (car host) (car (cdr host)) )) 
          (error "illegal uri-host char sequence .."))
        (T (host-grammar (cdr host) uri))
	)
  )

(defun port-grammar (port uri) 
  (cond ((numberp port) uri)
        ((equal (first uri) "mailto") uri)
        ((equal (first uri) "news") uri)
        ((equal (first uri) "fax") uri)
        ((equal (first uri) "tel") uri)
        )
  )

(defun return_scheme (x y)
  (if(equal (car x) #\:)
      (cond ((equal y '(#\o #\t #\l #\i #\a #\m)) 
             (return_fragment (reverse-list (cdr x)) 
			      NIL 
			      (cons (format nil "窿蝈鲥蝮瀛扉篝┅Ж┅┅è羼踽Ж＼＼＼＼瞟蝈趱蝾哝蜥珥孱蝈鲥蝮瀛扉篝ㄣ潋┅紊ㄣ镱ㄦ矧磲铋窿蝈鲥蝮瀛扉篝┅Ж┅┅è羼踽Ж＼＼＼舂蝈趱蝾哝蜥珥孱蝈鲥蝮瀛扉篝ㄣ潋┅紊ㄣ镱ㄦ矧磲铋窿蝈鲥蝮瀛扉篝┅Ж┅┅è羼踽Ж＼＼＼姗蝈趱蝾哝蜥珥孱蝈鲥蝮瀛扉篝ㄣ潋┅紊ㄣ镱ㄦ矧磲铋窿蝈鲥蝮瀛扉篝┅Ж┅┅ㄔ蝈趱蝾哝蜥珥孱蝈鲥蝮瀛扉篝筱桢礤哝轼弪┅紊ㄣ镱ㄦ矧磲铋窿蝈鲥蝮瀛扉篝┅Ж┅┅蝈趱蝾唧汨屙ㄣ潋ㄣ镱ㄣ狎┅ㄤ彐躅筱桢礤哝轼弪ㄣ镱è犷ㄥ聃犰翳轵＼铛祆ㄦ秕螋┅ㄥ蝌矧⑩徜栾篝┅è犷ㄥ聃犰箦泔钿＼铛祆翳轵┅ㄥ蝌矧⑩徜栾篝┅ㄔㄣ潋ㄣ潋ㄣ潋┅┅ㄤ彐躅蝈趱蝾哝蜥珥孱ㄣ镱è铛祆蝈趱蝾唏蹂蝙紊ㄣ镱⑽商┅è羼踽ㄣ狎＼）蝈趱蝾唏蹂蝙蝈鲥蝮瀛扉篝ㄣ潋┅紊ㄣ镱ㄦ矧磲铋窿┅┅ㄔ蝈趱蝾哝蜥珥孱ㄣ潋ㄣ镱ㄣ狎┅ㄤ彐躅蝈趱蝾唏蹂蝙ㄣ镱è铛祆蝈趱蝾哚豸栾蜷豉唣狒蝈鲥蝮瀛扉篝紊ㄣ镱⑽商┅è羼踽ㄣ狎＼咯蝈趱蝾哚豸栾蜷豉唣狒蝈鲥蝮瀛扉篝紊ㄣ镱ㄦ矧磲铋窿ㄣ潋┅┅ㄔ蝈趱蝾唏蹂蝙ㄣ潋ㄣ镱ㄣ狎┅ㄤ彐躅蝈趱蝾哚豸栾蜷豉唣狒ㄣ镱洙铛祆┄蝈趱蝾啧箦蜷铈蝈鲥蝮瀛扉篝紊ㄣ镱⑽商┅è羼踽ㄣ狎＼┄蝈趱蝾啧箦蜷铈蝈鲥蝮瀛扉篝紊ㄣ镱ㄦ矧磲铋窿ㄣ潋┅┅ㄔ蝈趱蝾哚豸栾蜷豉唣狒ㄣ潋ㄣ镱ㄣ狎┅ㄤ彐躅蝈趱蝾啧箦蜷铈ㄣ镱è铛祆┄蝈趱蝾唣矧蝈鲥蝮瀛扉篝紊ㄣ镱⑽商┅è羼踽歙汜＼扩蝈趱蝾唣矧ㄣ潋紊ㄣ镱ㄦ矧磲铋窿蝈鲥蝮瀛扉篝┅┅ㄔ蝈趱蝾啧箦蜷铈ㄣ潋ㄣ镱ㄣ狎┅ㄤ彐躅蝈趱蝾唣矧ㄣ镱è铛祆┄蝈趱蝾哞矬ㄣ镱Ж赴┅┅è羼踽ㄣ狎＼憨ㄣ镱è铛祆ㄣ潋┅ㄥ蝌矧㈤祆彗犰痫螋┅ㄔ蝈趱蝾哞矬ㄣ镱疳蝮瀛轭翦珏颞骘蝽狒铋窿ㄣ潋┅┅┅ㄔ蝈趱蝾唣矧ㄣ潋ㄣ镱ㄣ狎┅ㄤ彐躅蝈趱蝾哞矬舁ㄦ灬趑孱ㄣ镱ㄦ矧磲铋窿蝈鲥蝮瀛扉篝┅┅ㄤ彐躅躜榄筱桢礤ㄦ轵篝ㄤ彐躅躜榄躞弪轭骘ㄦ殒翳ㄤ彐躅躜榄栾篝箦鲥铘ㄤ彐躅躜榄痫螋箝翳ㄤ彐躅躜榄疳翳ㄦ秕螋ㄤ彐躅躜榄聃弪翳轵ㄤ彐躅躜榄骝徵礤铘箦泔钿ㄤ彐躅躜榄溟箴灬镳糸镱犰秕篝犷溽蜾秕麴豸ㄣ镱è铒铛祆秕舂镳孱篝蝈犴秕舂è铒铛祆篝犷溽蜾秕麴豸┅秕麴豸篝蝈犴秕舂ㄔㄦ矧磲⒂汨屙搴窿ア躜榄筱桢礤┅ㄦ矧磲⒄箦蜷铈锖窿ア躜榄躞弪轭骘┅ㄦ矧磲⑷矬艉窿ア躜榄栾篝┅ㄦ矧磲⑿矧艉窿ア躜榄痫螋┅ㄦ矧磲⑿狒韬窿ア躜榄疳翳┅ㄦ矧磲⒀蹂蝙窿ア躜榄聃弪┅ㄦ矧磲⑵蜥珥孱艉窿ア躜榄骝徵礤铘┅舂ㄤ彐躅泔铙孱ㄥ戾礤铘飑ㄩ铛祆飑扉篝屐屙孱舂ㄣ镱ㄦ轵篝飑ㄣ镱蟓孱屐屙孱蝈篝飑┅┅ㄤ彐躅蝈鲥蝮瀛扉篝飑ㄩ铛祆飑铋ㄣ镱蟓孱ㄣ狎飑蝈鲥蝮瀛扉篝蝈篝飑┅┅ㄤ彐躅骒狒翦ㄣ镱è铛祆è狒镯扉篝┅ㄔㄡ痧孱ㄦ灬趑孱ㄦ轵篝┅ㄦ灬趑孱蝈篝┅┅┅换蝈盹鲥瞽翳屐屙孱ㄤ彐躅蝈盹鲥瞟ㄣ镱è铛祆飑铋飑è癌ㄣ潋飑ㄔㄣ镱ㄣ狎飑蝈盹鲥ㄣ潋飑ō暴┅┅换换孱镦骈戾躜榄疳蝮瀹扉箴